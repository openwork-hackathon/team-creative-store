# Plan: Refactor `ai-creative.ts` for Enhanced Image Generation

## Summary
Refactor `generateImageWithGeminiFlash` to support:
1. **Logo integration** - Add brand logo to generated images
2. **Product/Reference images** - Use product shots and reference images for context
3. **Hook text** - Include the `proposedHook` text in generated images
4. **Aspect ratios** - Pass aspect ratio to Gemini API based on placement

## Architecture Overview

```
User Input (brief, brandAssets, placement)
        │
        ▼
┌─────────────────────────────────────┐
│  generateCreativeWithAi()            │
│  - Extract aspectRatio from placement│
│  - Build enhanced prompt with hook   │
│  - Group assets by kind              │
└─────────────────────────────────────┘
        │
        ▼
┌─────────────────────────────────────┐
│  Phase 1: generateBaseImage()        │
│  - Use product + reference images    │
│  - Include hook text in prompt       │
│  - Pass aspect ratio to Gemini       │
│  - Model: gemini-2.5-flash-image     │
└─────────────────────────────────────┘
        │
        ▼
┌─────────────────────────────────────┐
│  Phase 2: overlayLogo() (if logo)   │
│  - Take base image + logo            │
│  - Use gemini-3-pro-image-preview    │
│  - Natural logo placement prompt     │
└─────────────────────────────────────┘
        │
        ▼
Final Image with Hook Text + Logo
```

## Implementation Steps

### 1. Add helper: `placementToAspectRatio()`
Map `PlacementSpecKey` to Gemini-compatible aspect ratio strings:
```typescript
const ASPECT_RATIO_MAP: Record<PlacementSpecKey, string> = {
  square_1_1: "1:1",
  feed_4_5: "4:5",
  story_9_16: "9:16",
  landscape_16_9: "16:9",
  banner_ultrawide: "21:9",  // Closest supported ratio
  tv_4k: "16:9"              // Use 16:9 for TV
};
```

### 2. Add helper: `groupAssetsByKind()`
Separate brand assets into logo, product, and reference arrays:
```typescript
function groupAssetsByKind(assets: BrandAsset[]): {
  logos: BrandAsset[];
  products: BrandAsset[];
  references: BrandAsset[];
}
```

### 3. Update `GeminiImageInput` type
```typescript
type GeminiImageInput = {
  prompt: string;
  aspectRatio?: string;           // NEW: "1:1", "9:16", etc.
  productAssets?: BrandAsset[];   // NEW: Product shots for context
  referenceAssets?: BrandAsset[]; // NEW: Style/mood references
};
```

### 4. Refactor `generateImageWithGeminiFlash()`
- Pass `aspectRatio` to Gemini via `providerOptions.google.imageConfig`
- Include product and reference images as context
- Build prompt that instructs Gemini to render the hook text

### 5. Add `overlayLogoOnImage()` function
Two-step logo overlay using Pro model:
```typescript
async function overlayLogoOnImage(input: {
  baseImageDataUrl: string;
  logoAsset: BrandAsset;
}): Promise<string>
```

Uses prompt pattern from gemini-image-generator skill:
```
Add the logo from the second image onto a natural, appropriate surface 
in the first image. Preserve all original details. Match lighting, 
perspective, and texture so the logo appears naturally integrated.
```

### 6. Update `buildImagePrompt()`
Include hook text instruction:
```typescript
const buildImagePrompt = (input: CreativeGenerateInput) => {
  const hook = (input.brief as Brief)?.proposedHook;
  return [
    "Create a high-quality advertisement image.",
    `Aspect ratio: ${aspectRatio}.`,
    hook ? `Include this text prominently in the image: "${hook}"` : null,
    `Campaign intent: ${input.intentText ?? "modern marketing aesthetic"}.`,
    // ... rest of prompt
  ].filter(Boolean).join(" ");
};
```

### 7. Update `generateCreativeWithAi()` orchestration
```typescript
export async function generateCreativeWithAi(input: CreativeGenerateInput) {
  const { logos, products, references } = groupAssetsByKind(input.brandAssets ?? []);
  const aspectRatio = placementToAspectRatio(input.placement);
  
  // Phase 1: Generate base image with products, references, and hook text
  let generatedImage = await generateImageWithGeminiFlash({
    prompt: buildImagePrompt(input),
    aspectRatio,
    productAssets: products,
    referenceAssets: references
  });
  
  // Phase 2: Overlay logo if provided
  if (logos.length > 0) {
    generatedImage = await overlayLogoOnImage({
      baseImageDataUrl: generatedImage,
      logoAsset: logos[0]  // Use first logo
    });
  }
  
  // Continue with HTML generation...
}
```

## Files to Modify

| File | Changes |
|------|---------|
| `packages/api/src/ai-creative.ts` | Refactor image generation, add logo overlay, add aspect ratio support |
| `packages/api/src/ai-routes.test.ts` | Update tests for new parameters |

## Key Design Decisions

1. **Two-phase image generation**: Base image first, logo overlay second (following gemini-image-generator skill pattern)
2. **Pro model for logo overlay**: Logo placement requires higher fidelity (gemini-3-pro-image-preview)
3. **Flash model for base**: Keep using gemini-2.5-flash-image for speed
4. **Aspect ratio from placement**: Derive from existing placement specs, no new input needed
5. **Hook text in prompt**: Let Gemini render text natively (better integration than post-processing)

## Gemini Model Selection

| Task | Model | Reason |
|------|-------|--------|
| Base image generation | `gemini-2.5-flash-image` | Faster, supports aspect ratios |
| Logo overlay | `gemini-3-pro-image-preview` | Better quality for compositing |

## Aspect Ratio Mapping

| PlacementSpecKey | Gemini Aspect Ratio |
|------------------|---------------------|
| `square_1_1` | `1:1` |
| `feed_4_5` | `4:5` |
| `story_9_16` | `9:16` |
| `landscape_16_9` | `16:9` |
| `banner_ultrawide` | `21:9` |
| `tv_4k` | `16:9` |

## Prompt Engineering Patterns (from skill reference)

### Base Image with Hook Text
```
Create a high-quality advertisement image at [ASPECT_RATIO] aspect ratio.
Include this text prominently and legibly in the image: "[HOOK_TEXT]"
The text should be styled to match the overall design aesthetic.
Campaign intent: [INTENT]. Style: [STYLE].
```

### Logo Overlay
```
Add the logo from the second image onto a natural, appropriate surface 
in the first image (such as a sign, device, or packaging).
Preserve all original details and the hook text.
Match lighting, perspective, and texture so the logo appears 
printed or applied to the surface.
Do not alter faces or key features.
```

## Verification

1. Run tests: `pnpm --filter @creative-store/api test`
2. Manual test via API: `POST /api/ai/creative/generate`
3. Verify:
   - Hook text appears in generated image
   - Aspect ratio matches placement
   - Logo is naturally integrated (when provided)
   - Product/reference images influence style
