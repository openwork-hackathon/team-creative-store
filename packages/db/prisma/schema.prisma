generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

enum CreativeStatus {
  draft
  published
  archived
}

enum ProjectStatus {
  draft
  generating
  ready
  published
}

enum VersionStatus {
  draft
  published
}

enum JobStatus {
  queued
  running
  succeeded
  failed
}

enum NftStatus {
  pending
  confirmed
  failed
}

enum PublishCategory {
  ads
  branding
  e_commerce
  gaming
}

enum LicenseType {
  standard
  extended
  exclusive
}

model User {
  id            String    @id @default(uuid())
  name          String?
  email         String    @unique
  emailVerified Boolean   @default(false)
  image         String?
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt
  sessions      Session[]
  accounts      Account[]
  projects      Project[]
  publishRecords PublishRecord[] @relation("PublishRecordCreator")
  purchases     Purchase[]      @relation("PurchaseBuyer")
}

model Session {
  id        String   @id @default(uuid())
  userId    String
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  token     String   @unique
  expiresAt DateTime
  ipAddress String?
  userAgent String?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model Account {
  id                     String   @id @default(uuid())
  userId                 String
  user                   User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  accountId              String
  providerId             String
  accessToken            String?
  refreshToken           String?
  accessTokenExpiresAt   DateTime?
  refreshTokenExpiresAt  DateTime?
  scope                  String?
  idToken                String?
  password               String?
  createdAt              DateTime @default(now())
  updatedAt              DateTime @updatedAt

  @@unique([providerId, accountId])
}

model Verification {
  id         String   @id @default(uuid())
  identifier String
  value      String
  expiresAt  DateTime
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt
}

model Project {
  id        String        @id @default(uuid())
  userId    String
  user      User          @relation(fields: [userId], references: [id])
  name      String
  status    ProjectStatus @default(draft)
  imageUrl  String?
  createdAt DateTime      @default(now())
  updatedAt DateTime      @updatedAt
  briefs    Brief[]
  creatives Creative[]
}

model Brief {
  id          String   @id @default(uuid())
  projectId   String
  project     Project  @relation(fields: [projectId], references: [id])
  intentText  String
  briefJson   Json
  constraints Json
  status      String   @default("draft")
  createdAt   DateTime @default(now())
  drafts      Draft[]
}

model Draft {
  id            String   @id @default(uuid())
  briefId       String
  brief         Brief    @relation(fields: [briefId], references: [id])
  draftJson     Json
  previewAssetId String?
  createdAt     DateTime @default(now())
}

model Creative {
  id        String         @id @default(uuid())
  projectId String
  project   Project        @relation(fields: [projectId], references: [id])
  title     String
  status    CreativeStatus @default(draft)
  createdAt DateTime       @default(now())
  versions  CreativeVersion[]
  publishRecords PublishRecord[]
}

model CreativeVersion {
  id           String       @id @default(uuid())
  creativeId   String
  creative     Creative      @relation(fields: [creativeId], references: [id])
  versionName  String
  baseCanvasKey String
  sourceTree   Json
  prompts      Json
  status       VersionStatus @default(draft)
  createdAt    DateTime      @default(now())
  renderJobs   RenderJob[]
  publishRecords PublishRecord[]
  nft          NftRecord?
}

model PlacementSpec {
  id       String @id @default(uuid())
  key      String @unique
  width    Int
  height   Int
  safeArea Json
  rules    Json
  category String
  renderJobs RenderJob[]
}

model RenderJob {
  id            String   @id @default(uuid())
  versionId     String
  version       CreativeVersion @relation(fields: [versionId], references: [id])
  placementSpecId String
  placementSpec PlacementSpec @relation(fields: [placementSpecId], references: [id])
  status        JobStatus @default(queued)
  error         String?
  createdAt     DateTime @default(now())
  startedAt     DateTime?
  finishedAt    DateTime?
  render        Render?
}

model Render {
  id         String   @id @default(uuid())
  renderJobId String  @unique
  renderJob  RenderJob @relation(fields: [renderJobId], references: [id])
  url        String
  width      Int
  height     Int
  format     String
  hash       String
  createdAt  DateTime @default(now())
}

model PublishRecord {
  id              String          @id @default(uuid())
  creativeId      String
  creative        Creative        @relation(fields: [creativeId], references: [id])
  versionId       String
  version         CreativeVersion @relation(fields: [versionId], references: [id])
  creatorId       String
  creator         User            @relation("PublishRecordCreator", fields: [creatorId], references: [id])
  slug            String          @unique
  title           String
  description     String?
  imageUrl        String?
  category        PublishCategory @default(ads)
  assetType       AssetType       @default(ad_kit)
  licenseType     LicenseType     @default(standard)
  tags            String[]
  priceAicc       Decimal         @db.Decimal(18, 2)
  rating          Decimal         @default(0) @db.Decimal(2, 1)
  reviewCount     Int             @default(0)
  isPremium       Boolean         @default(false)
  status          ListingStatus   @default(active)
  includeSourceFiles Boolean      @default(false)
  publishedAt     DateTime        @default(now())
  purchases       Purchase[]
}

model NftRecord {
  id           String   @id @default(uuid())
  versionId    String   @unique
  version      CreativeVersion @relation(fields: [versionId], references: [id])
  chain        String
  contractAddress String
  tokenId      String
  txHash       String
  metadataUri  String
  contentHash  String
  status       NftStatus @default(pending)
  mintedAt     DateTime?
}

// Marketplace models
enum ListingStatus {
  active
  sold
  delisted
}

enum AssetType {
  ad_kit
  branding
  character
  ui_kit
  background
  template
  logo
  scene_3d
}

model Purchase {
  id              String        @id @default(uuid())
  publishRecordId String
  publishRecord   PublishRecord @relation(fields: [publishRecordId], references: [id])
  buyerId         String
  buyer           User          @relation("PurchaseBuyer", fields: [buyerId], references: [id])
  priceAicc       Decimal       @db.Decimal(18, 2)
  txHash          String?
  createdAt       DateTime      @default(now())
}
